name: 📊 Server Health Monitor

on:
  schedule:
    # Run detailed health check every 2 hours during active hours (10 AM - 9 PM IST = 4:30 AM - 3:30 PM UTC)
    - cron: '0 4,6,8,10,12,14 * * *'  # At 4 AM, 6 AM, 8 AM, 10 AM, 12 PM, 2 PM UTC (9:30 AM - 7:30 PM IST)
  
  workflow_dispatch:

jobs:
  health-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🏥 Comprehensive Health Check
      run: |
        echo "🔍 Running comprehensive health check at $(date)"
        echo "⏰ Active monitoring: 10 AM - 9 PM IST (4:30 AM - 3:30 PM UTC)"
        
        SERVER_URL="${{ secrets.RENDER_SERVER_URL || 'https://your-app-name.onrender.com' }}"
        
        # Test multiple endpoints
        endpoints=(
          "/health"
          "/"
          "/files/status"
        )
        
        all_healthy=true
        
        for endpoint in "${endpoints[@]}"; do
          echo "🌐 Testing endpoint: $endpoint"
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\nTIME_TOTAL:%{time_total}" \
            --max-time 15 \
            "$SERVER_URL$endpoint" || echo "CURL_FAILED")
          
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          time_total=$(echo "$response" | grep "TIME_TOTAL:" | cut -d: -f2)
          
          if [ "$http_status" = "200" ]; then
            echo "✅ $endpoint: OK (${time_total}s)"
          else
            echo "❌ $endpoint: FAILED (Status: $http_status)"
            all_healthy=false
          fi
        done
        
        # Test database connectivity (if uploaded files exist)
        echo "🗄️ Testing database connectivity..."
        db_response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          --max-time 10 \
          "$SERVER_URL/downloads" || echo "CURL_FAILED")
        
        db_status=$(echo "$db_response" | grep "HTTP_STATUS:" | cut -d: -f2)
        if [ "$db_status" = "200" ]; then
          echo "✅ Database: OK"
        else
          echo "⚠️ Database: Issues detected (Status: $db_status)"
        fi
        
        # Overall health summary
        if [ "$all_healthy" = true ]; then
          echo "🎉 All systems healthy during IST active hours!"
          echo "::notice::Server health check passed - All endpoints responding"
        else
          echo "⚠️ Some issues detected during IST active hours"
          echo "::warning::Server health check found issues - Check logs"
        fi

    - name: 📈 Generate Usage Report
      run: |
        echo "📊 GitHub Actions Usage Report"
        echo "=============================="
        echo "🕐 Check time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "⏰ User active hours: 10 AM - 9 PM IST (4:30 AM - 3:30 PM UTC)"
        echo "🔄 Keep-alive frequency: Every 10 minutes"
        echo "📊 Daily pings: 66"
        echo "📈 Monthly usage: 1,980 minutes (66% of budget)"
        echo "💰 Budget: 3,000 minutes"
        echo "🎯 Remaining budget: 1,020 minutes"
        echo "🛡️ Health checks: 6 times daily (12 minutes/month)"
        echo "✨ Total monthly usage: ~2,000 minutes"
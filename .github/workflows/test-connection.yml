name: ğŸ§ª Test Server Connection

on:
  workflow_dispatch:
    inputs:
      server_url:
        description: 'Server URL to test (optional - uses secret if not provided)'
        required: false
        type: string

jobs:
  test-connection:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”§ Setup Test Parameters
      run: |
        if [ -n "${{ github.event.inputs.server_url }}" ]; then
          echo "SERVER_URL=${{ github.event.inputs.server_url }}" >> $GITHUB_ENV
        else
          echo "SERVER_URL=${{ secrets.RENDER_SERVER_URL || 'https://your-app-name.onrender.com' }}" >> $GITHUB_ENV
        fi
        echo "ğŸ¯ Testing server: $SERVER_URL"

    - name: ğŸ“ Basic Ping Test
      run: |
        echo "ğŸš€ Starting basic connectivity test..."
        
        response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\nTIME_TOTAL:%{time_total}\nTIME_CONNECT:%{time_connect}" \
          --max-time 30 \
          "$SERVER_URL/health")
        
        echo "ğŸ“„ Response body:"
        echo "$response" | head -n -3
        echo ""
        
        http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
        time_total=$(echo "$response" | grep "TIME_TOTAL:" | cut -d: -f2)
        time_connect=$(echo "$response" | grep "TIME_CONNECT:" | cut -d: -f2)
        
        echo "ğŸ“Š Connection Stats:"
        echo "   Status: $http_status"
        echo "   Connect time: ${time_connect}s"
        echo "   Total time: ${time_total}s"
        
        if [ "$http_status" = "200" ]; then
          echo "âœ… Basic ping test PASSED"
        else
          echo "âŒ Basic ping test FAILED"
          exit 1
        fi

    - name: ğŸŒ Endpoint Discovery
      run: |
        echo "ğŸ” Testing available endpoints..."
        
        endpoints=(
          "/"
          "/health"
          "/catalog/series"
          "/files/status" 
          "/downloads"
          "/storage/info"
        )
        
        for endpoint in "${endpoints[@]}"; do
          echo "ğŸŒ Testing: $endpoint"
          
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 10 \
            "$SERVER_URL$endpoint" || echo "TIMEOUT")
          
          case $status in
            200) echo "   âœ… $endpoint: OK" ;;
            404) echo "   âš ï¸ $endpoint: Not Found" ;;
            500) echo "   âŒ $endpoint: Server Error" ;;
            TIMEOUT) echo "   â° $endpoint: Timeout" ;;
            *) echo "   â“ $endpoint: Status $status" ;;
          esac
        done

    - name: ğŸ¯ Keep-Alive Simulation (10 AM - 9 PM Pattern)
      run: |
        echo "ğŸ”„ Simulating keep-alive pings for active hours..."
        echo "â° Pattern: Every 10 minutes during 10 AM - 9 PM"
        
        for i in {1..5}; do
          echo "ğŸ“¡ Ping $i/5..."
          
          start_time=$(date +%s.%N)
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 15 \
            "$SERVER_URL/health")
          end_time=$(date +%s.%N)
          
          duration=$(echo "$end_time - $start_time" | bc)
          
          if [ "$status" = "200" ]; then
            echo "   âœ… Ping $i: OK (${duration}s)"
          else
            echo "   âŒ Ping $i: FAILED (Status: $status)"
          fi
          
          # Wait 2 seconds between pings
          sleep 2
        done
        
        echo "ğŸ‰ Keep-alive simulation complete!"

    - name: ğŸ“‹ Test Summary
      if: always()
      run: |
        echo "ğŸ“Š Test Summary for 10 AM - 9 PM Schedule"
        echo "========================================"
        echo "ğŸ• Test completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ¯ Server URL: $SERVER_URL"
        echo "â° Active hours: 10 AM - 9 PM UTC (11 hours daily)"
        echo "ğŸ”„ Ping frequency: Every 10 minutes"
        echo "ğŸ“… Daily pings: 66"
        echo "ğŸ“ˆ Monthly usage: 1,980 minutes"
        echo "ğŸ’° Budget efficiency: 66% of 3,000 minutes"
        echo "ğŸ”§ GitHub Actions environment: ubuntu-latest"
        echo "ğŸ“ˆ Ready for optimized keep-alive deployment!"